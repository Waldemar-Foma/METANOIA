{% extends "base.html" %}

{% block title %}Аналитика сессий - {{ patient.name }}{% endblock %}

{% block content %}
<div class="analytics-header">
    <div class="header-content">
        <h1><i class="fas fa-chart-line"></i> Аналитика сессий</h1>
        <p>Детальный анализ прогресса терапии {{ patient.name }}</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-outline" onclick="exportData()">
            <i class="fas fa-download"></i> Экспорт данных
        </button>
        <a href="{{ url_for('patient_dashboard') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Назад к панели
        </a>
    </div>
</div>

{% if sessions %}
<div class="grid grid-2">
    <!-- Основная статистика -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Общая статистика</h3>
        </div>
        <div class="stats-grid">
            <div class="stat">
                <div class="stat-value">{{ sessions|length }}</div>
                <div class="stat-label">Всего сессий</div>
            </div>
            <div class="stat">
                <div class="stat-value">
                    {{ sessions|sum(attribute='duration_minutes') }}
                </div>
                <div class="stat-label">Минут терапии</div>
            </div>
            <div class="stat">
                <div class="stat-value">
                    {{ "%.1f"|format((sessions|sum(attribute='pre_sud') - sessions|sum(attribute='post_sud')) / sessions|length) }}
                </div>
                <div class="stat-label">Среднее ΔSUD</div>
            </div>
            <div class="stat">
                <div class="stat-value">
                    {{ (sessions|selectattr('post_sud', '<=', 3)|list|length / sessions|length * 100)|round }}%
                </div>
                <div class="stat-label">Сессий с SUD ≤ 3</div>
            </div>
        </div>
    </div>

    <!-- Эффективность -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Эффективность терапии</h3>
        </div>
        <div class="efficiency-metrics">
            <div class="efficiency-item">
                <div class="efficiency-label">Общий прогресс</div>
                <div class="efficiency-bar">
                    <div class="efficiency-fill" style="width: {{ ((sessions[0].pre_sud - sessions[-1].post_sud) / sessions[0].pre_sud * 100)|round }}%"></div>
                </div>
                <div class="efficiency-value">
                    {{ sessions[0].pre_sud }} → {{ sessions[-1].post_sud }}
                </div>
            </div>
            <div class="efficiency-item">
                <div class="efficiency-label">Среднее снижение за сессию</div>
                <div class="efficiency-value positive">
                    {{ "%.1f"|format((sessions|sum(attribute='pre_sud') - sessions|sum(attribute='post_sud')) / sessions|length) }} пунктов
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Графики -->
<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Динамика SUD</h3>
        </div>
        <div class="chart-container">
            <canvas id="sudChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Эффективность сессий</h3>
        </div>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
    </div>
</div>

<!-- Детальная таблица сессий -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">История сессий</h3>
    </div>
    <div class="sessions-table-container">
        <table class="sessions-table">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Модуль</th>
                    <th>Длительность</th>
                    <th>Pre-SUD</th>
                    <th>Post-SUD</th>
                    <th>ΔSUD</th>
                    <th>Эффективность</th>
                </tr>
            </thead>
            <tbody>
                {% for session in sessions|reverse %}
                <tr>
                    <td>{{ session.date[:10] }}</td>
                    <td>{{ session.module_used }}</td>
                    <td>{{ session.duration_minutes }} мин</td>
                    <td class="sud-value pre-sud">{{ session.pre_sud }}</td>
                    <td class="sud-value post-sud">{{ session.post_sud }}</td>
                    <td class="sud-difference {{ 'positive' if session.post_sud - session.pre_sud < 0 else 'negative' }}">
                        {{ session.post_sud - session.pre_sud }}
                    </td>
                    <td>
                        <div class="efficiency-badge {{ 'high' if session.pre_sud - session.post_sud >= 3 else 'medium' if session.pre_sud - session.post_sud >= 1 else 'low' }}">
                            {% if session.pre_sud - session.post_sud >= 3 %}
                                Высокая
                            {% elif session.pre_sud - session.post_sud >= 1 %}
                                Средняя
                            {% else %}
                                Низкая
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% else %}
<div class="empty-state">
    <i class="fas fa-chart-line"></i>
    <h4>Данные для анализа отсутствуют</h4>
    <p>Проведите несколько сессий для отслеживания прогресса</p>
</div>
{% endif %}

<style>
.analytics-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-content h1 {
    color: var(--dark);
    margin-bottom: 0.5rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    text-align: center;
}

.efficiency-metrics {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.efficiency-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.efficiency-label {
    font-weight: 600;
    color: var(--dark);
}

.efficiency-bar {
    width: 100%;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
}

.efficiency-fill {
    height: 100%;
    background: var(--success);
    transition: width 0.3s;
}

.efficiency-value {
    font-weight: 600;
}

.efficiency-value.positive {
    color: var(--success);
}

.efficiency-value.negative {
    color: var(--danger);
}

.sessions-table-container {
    overflow-x: auto;
}

.sessions-table {
    width: 100%;
    border-collapse: collapse;
}

.sessions-table th {
    background: var(--light);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark);
    border-bottom: 2px solid var(--border);
}

.sessions-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.sud-value {
    font-weight: 600;
    text-align: center;
}

.pre-sud {
    color: var(--danger);
}

.post-sud {
    color: var(--success);
}

.sud-difference {
    font-weight: 600;
    text-align: center;
}

.sud-difference.positive {
    color: var(--success);
}

.sud-difference.negative {
    color: var(--danger);
}

.efficiency-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
}

.efficiency-badge.high {
    background: #dcfce7;
    color: #166534;
}

.efficiency-badge.medium {
    background: #fef3c7;
    color: #92400e;
}

.efficiency-badge.low {
    background: #fee2e2;
    color: #991b1b;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .analytics-header {
        flex-direction: column;
        gap: 1rem;
        align-items: start;
    }
}
</style>

{% if sessions %}
<script>
// Загрузка данных для графиков
fetch('{{ url_for("patient_sessions_data", patient_id=patient.user_id) }}')
    .then(response => response.json())
    .then(sessionsData => {
        if (window.chartManager && sessionsData.length > 0) {
            window.chartManager.createSUDChart('sudChart', sessionsData);
            window.chartManager.createProgressChart('progressChart', sessionsData);
        }
    });

function exportData() {
    // Экспорт данных в CSV
    alert('Экспорт данных сессий');
    // Реализация экспорта данных
}
</script>
{% endif %}
{% endblock %}